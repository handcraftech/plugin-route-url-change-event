{"version":3,"file":"url-change-event.js","sources":["../src/UrlChangeEvent.js","../src/constants.js","../src/stateCache.js","../src/override.js","../src/index.js"],"sourcesContent":["export default class UrlChangeEvent extends Event {\r\n  constructor(option = {}) {\r\n    super('urlchange', { cancelable: true, ...option })\r\n    this.newURL = option.newURL\r\n    this.oldURL = option.oldURL\r\n    this.action = option.action\r\n  }\r\n\r\n  get [Symbol.toStringTag]() {\r\n    return 'UrlChangeEvent'\r\n  }\r\n}\r\n","export const originPushState = window.history.pushState.bind(window.history)\r\nexport const originReplaceState = window.history.replaceState.bind(window.history)","import { originReplaceState } from './constants'\r\n\r\nexport let cacheURL\r\nexport let cacheIndex\r\n\r\nexport function initState() {\r\n  const state = window.history.state\r\n  if (!state || typeof state._index !== 'number') {\r\n    originReplaceState({ _index: window.history.length, ...state }, null, null)\r\n  }\r\n}\r\n\r\nexport function updateCacheState() {\r\n  cacheURL = new URL(window.location.href)\r\n  cacheIndex = window.history.state._index\r\n}\r\n\r\ninitState()\r\nupdateCacheState()\r\n","import UrlChangeEvent from './UrlChangeEvent'\r\nimport { cacheURL, cacheIndex, updateCacheState } from './stateCache'\r\nimport { originPushState, originReplaceState } from './constants'\r\n\r\nwindow.history.pushState = function (state, title, url) {\r\n  const nowURL = new URL(url || '', window.location.href)\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      newURL: nowURL,\r\n      oldURL: cacheURL,\r\n      action: 'pushState',\r\n    })\r\n  )\r\n\r\n  if (notCanceled) {\r\n    originPushState({ _index: cacheIndex + 1, ...state }, title, url)\r\n    updateCacheState()\r\n  }\r\n}\r\n\r\nwindow.history.replaceState = function (state, title, url) {\r\n  const nowURL = new URL(url || '', window.location.href)\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      newURL: nowURL,\r\n      oldURL: cacheURL,\r\n      action: 'replaceState',\r\n    })\r\n  )\r\n\r\n  if (notCanceled) {\r\n    originReplaceState({ _index: cacheIndex, ...state }, title, url)\r\n    updateCacheState()\r\n  }\r\n}\r\n","import UrlChangeEvent from './UrlChangeEvent'\r\nimport { initState, cacheURL, cacheIndex, updateCacheState } from './stateCache'\r\nimport './override'\r\n\r\nwindow.addEventListener('popstate', function (e) {\r\n  initState()\r\n  const nowIndex = window.history.state._index\r\n  const nowURL = new URL(window.location)\r\n  if (nowIndex === cacheIndex) {\r\n    e.stopImmediatePropagation()\r\n    return\r\n  }\r\n\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      oldURL: cacheURL,\r\n      newURL: nowURL,\r\n      action: 'popstate',\r\n    })\r\n  )\r\n\r\n  if (!notCanceled) {\r\n    e.stopImmediatePropagation()\r\n    window.history.go(cacheIndex - nowIndex)\r\n    return\r\n  }\r\n  updateCacheState()\r\n})\r\n\r\nwindow.addEventListener('beforeunload', function (e) {\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      oldURL: cacheURL,\r\n      newURL: null,\r\n      action: 'beforeunload',\r\n    })\r\n  )\r\n\r\n  if (!notCanceled) {\r\n    e.preventDefault()\r\n    const confirmationMessage = 'o/'\r\n    e.returnValue = confirmationMessage\r\n    return confirmationMessage\r\n  }\r\n})\r\n"],"names":[],"mappings":"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"}