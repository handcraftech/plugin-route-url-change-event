{"version":3,"file":"url-change-event.min.js","sources":["../src/UrlChangeEvent.js","../src/stateCache.js","../src/constants.js","../src/override.js","../src/index.js"],"sourcesContent":["export default class UrlChangeEvent extends Event {\r\n  constructor(option = {}) {\r\n    super('urlchange', { cancelable: true, ...option })\r\n    this.newURL = option.newURL\r\n    this.oldURL = option.oldURL\r\n    this.action = option.action\r\n  }\r\n\r\n  get [Symbol.toStringTag]() {\r\n    return 'UrlChangeEvent'\r\n  }\r\n}\r\n","import { originReplaceState } from './constants'\r\n\r\nexport let cacheURL\r\nexport let cacheIndex\r\n\r\nexport function initState() {\r\n  const state = window.history.state\r\n  if (!state || typeof state._index !== 'number') {\r\n    originReplaceState({ _index: window.history.length, ...state }, null, null)\r\n  }\r\n}\r\n\r\nexport function updateCacheState() {\r\n  cacheURL = new URL(window.location.href)\r\n  cacheIndex = window.history.state._index\r\n}\r\n\r\ninitState()\r\nupdateCacheState()\r\n","export const originPushState = window.history.pushState.bind(window.history)\r\nexport const originReplaceState = window.history.replaceState.bind(window.history)","import UrlChangeEvent from './UrlChangeEvent'\r\nimport { cacheURL, cacheIndex, updateCacheState } from './stateCache'\r\nimport { originPushState, originReplaceState } from './constants'\r\n\r\nwindow.history.pushState = function (state, title, url) {\r\n  const nowURL = new URL(url || '', window.location.href)\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      newURL: nowURL,\r\n      oldURL: cacheURL,\r\n      action: 'pushState',\r\n    })\r\n  )\r\n\r\n  if (notCanceled) {\r\n    originPushState({ _index: cacheIndex + 1, ...state }, title, url)\r\n    updateCacheState()\r\n  }\r\n}\r\n\r\nwindow.history.replaceState = function (state, title, url) {\r\n  const nowURL = new URL(url || '', window.location.href)\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      newURL: nowURL,\r\n      oldURL: cacheURL,\r\n      action: 'replaceState',\r\n    })\r\n  )\r\n\r\n  if (notCanceled) {\r\n    originReplaceState({ _index: cacheIndex, ...state }, title, url)\r\n    updateCacheState()\r\n  }\r\n}\r\n","import UrlChangeEvent from './UrlChangeEvent'\r\nimport { initState, cacheURL, cacheIndex, updateCacheState } from './stateCache'\r\nimport './override'\r\n\r\nwindow.addEventListener('popstate', function (e) {\r\n  initState()\r\n  const nowIndex = window.history.state._index\r\n  const nowURL = new URL(window.location)\r\n  if (nowIndex === cacheIndex) {\r\n    e.stopImmediatePropagation()\r\n    return\r\n  }\r\n\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      oldURL: cacheURL,\r\n      newURL: nowURL,\r\n      action: 'popstate',\r\n    })\r\n  )\r\n\r\n  if (!notCanceled) {\r\n    e.stopImmediatePropagation()\r\n    window.history.go(cacheIndex - nowIndex)\r\n    return\r\n  }\r\n  updateCacheState()\r\n})\r\n\r\nwindow.addEventListener('beforeunload', function (e) {\r\n  const notCanceled = window.dispatchEvent(\r\n    new UrlChangeEvent({\r\n      oldURL: cacheURL,\r\n      newURL: null,\r\n      action: 'beforeunload',\r\n    })\r\n  )\r\n\r\n  if (!notCanceled) {\r\n    e.preventDefault()\r\n    const confirmationMessage = 'o/'\r\n    e.returnValue = confirmationMessage\r\n    return confirmationMessage\r\n  }\r\n})\r\n"],"names":["UrlChangeEvent","cacheURL","cacheIndex","_Event","_this","option","arguments","length","undefined","_classCallCheck","_callSuper","this","_objectSpread","cancelable","newURL","oldURL","action","_inherits","_createClass","key","Symbol","toStringTag","get","_wrapNativeSuper","Event","originPushState","window","history","pushState","bind","originReplaceState","replaceState","initState","state","_index","updateCacheState","URL","location","href","title","url","nowURL","dispatchEvent","addEventListener","e","nowIndex","stopImmediatePropagation","go","preventDefault","returnValue"],"mappings":"mzFAAqBA,ICEVC,EACAC,EDHUF,WAAcG,GACjC,SAAAH,IAAyB,IAAAI,EAAbC,EAAMC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAA,EAIQ,mGAJNG,MAAAT,IACrBI,EAAAM,EAAAC,KAAAX,EAAA,CAAM,YAAWY,EAAA,CAAIC,YAAY,GAASR,MACrCS,OAAST,EAAOS,OACrBV,EAAKW,OAASV,EAAOU,OACrBX,EAAKY,OAASX,EAAOW,OAAMZ,CAC7B,CAAC,4RAAAa,CAAAjB,EAAAG,GAAAe,EAAAlB,EAAA,CAAA,CAAAmB,IAEIC,OAAOC,YAAWC,IAAvB,WACE,MAAO,gBACT,IAAC,EAAAC,EAVyCC,QEA/BC,EAAkBC,OAAOC,QAAQC,UAAUC,KAAKH,OAAOC,SACvDG,EAAqBJ,OAAOC,QAAQI,aAAaF,KAAKH,OAAOC,SDInE,SAASK,IACd,IAAMC,EAAQP,OAAOC,QAAQM,MACxBA,GAAiC,iBAAjBA,EAAMC,QACzBJ,EAAkBlB,EAAA,CAAGsB,OAAQR,OAAOC,QAAQpB,QAAW0B,GAAS,KAAM,KAE1E,CAEO,SAASE,IACdlC,EAAW,IAAImC,IAAIV,OAAOW,SAASC,MACnCpC,EAAawB,OAAOC,QAAQM,MAAMC,MACpC,CAEAF,IACAG,IEdAT,OAAOC,QAAQC,UAAY,SAAUK,EAAOM,EAAOC,GACjD,IAAMC,EAAS,IAAIL,IAAII,GAAO,GAAId,OAAOW,SAASC,MAC9BZ,OAAOgB,cACzB,IAAI1C,EAAe,CACjBc,OAAQ2B,EACR1B,OAAQd,EACRe,OAAQ,iBAKVS,EAAeb,EAAA,CAAGsB,OAAQhC,EAAa,GAAM+B,GAASM,EAAOC,GAC7DL,IAEJ,EAEAT,OAAOC,QAAQI,aAAe,SAAUE,EAAOM,EAAOC,GACpD,IAAMC,EAAS,IAAIL,IAAII,GAAO,GAAId,OAAOW,SAASC,MAC9BZ,OAAOgB,cACzB,IAAI1C,EAAe,CACjBc,OAAQ2B,EACR1B,OAAQd,EACRe,OAAQ,oBAKVc,EAAkBlB,EAAA,CAAGsB,OAAQhC,GAAe+B,GAASM,EAAOC,GAC5DL,IAEJ,EC9BAT,OAAOiB,iBAAiB,WAAY,SAAUC,GAC5CZ,IACA,IAAMa,EAAWnB,OAAOC,QAAQM,MAAMC,OAChCO,EAAS,IAAIL,IAAIV,OAAOW,UAC9B,GAAIQ,IAAa3C,EAAjB,CAaA,IARoBwB,OAAOgB,cACzB,IAAI1C,EAAe,CACjBe,OAAQd,EACRa,OAAQ2B,EACRzB,OAAQ,cAOV,OAFA4B,EAAEE,gCACFpB,OAAOC,QAAQoB,GAAG7C,EAAa2C,GAGjCV,GAfA,MAFES,EAAEE,0BAkBN,GAEApB,OAAOiB,iBAAiB,eAAgB,SAAUC,GAShD,IARoBlB,OAAOgB,cACzB,IAAI1C,EAAe,CACjBe,OAAQd,EACRa,OAAQ,KACRE,OAAQ,kBAIM,CAChB4B,EAAEI,iBAGF,OADAJ,EAAEK,YAD0B,SAG9B,CACF"}